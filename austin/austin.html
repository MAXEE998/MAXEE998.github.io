<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
    <script type="text/javascript" src="data_process.js"></script>
    <script type="text/javascript" src="barchart_closure.js"></script>
    <script type="text/javascript" src="linechart_closure.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <h1>Austin Criminal Analytical Map</h1>
    <div class="maincontainer">
        <div id="main_graph">
            <span id="SelectionNode">
                <a> Current ZIP Zone: </a><a id="currentSelection">Austin</a>
                <button id="restore" type="button">Restore</button>
            </span>
        </div>
        <div id="sub_graphs">

            <div id="category_graph">
                <h3> Crime Catagory Graph </h3>
            </div>

            <div id="time_series_graph">
                <h3> Monthly Criminal Graph </h3>
            </div>
        </div>
    </div>

    <script>
       // Main view dimension {MARKER}
        const main_height = 750;
        const main_width = 750;
        const main_margin = {
            "top": 10,
            "bottom": 10,
            "left": 10,
            "right": 10
        };

        // Sub view dimension
        const sec_height = 350;
        const sec_width = 350;
        const sec_margin = {
            "top": 12,
            "bottom": 12,
            "left": 20,
            "right": 12
        };
        // append svgs
        var cat_graph = d3.select("#category_graph").append("svg")
            .attr("width", sec_width + sec_margin.left + sec_margin.right)
            .attr("height", sec_height + sec_margin.top + sec_margin.bottom);
        var main_legend = d3.select("#main_graph").append("svg")
            .attr("transform", "translate(0,800)")
            .attr("width", 600)
            .attr("height", 100);
        var main = d3.select("#main_graph").append("svg")
            .attr("transform", "translate(750,-105)")
            .attr("width", main_width + main_margin.left + main_margin.right)
            .attr("height", main_height + main_margin.top + main_margin.bottom);
        var time_graph = d3.select("#time_series_graph").append("svg")
            .attr("width", sec_width + sec_margin.left + sec_margin.right)
            .attr("height", sec_height + sec_margin.top + sec_margin.bottom);
        // main view color mapping
        var color_range = ["#a6cfc8", "#daf8e3", "#ffca2a", "#ffa501","#ff8d00","#ff6400","#ff4400","#fc2a1c"];
        // var index_note = ["Little Crimes", "Some Crimes", "Many Crimes", "Lots of Crimes"];
        var color = d3.scaleQuantize().range(color_range);
        // color changed when selected
        // const opacity = 0.6;
        function selected() {return d3.select(this).attr('stroke', 'yellow').attr("stroke-width",4)};
        function restored() {return d3.select(this).attr('stroke', "black").attr("stroke-width",1)};

        // define draw_legend
        function draw_legend() {
            // draw the color legend
            main_legend.append("rect")
                .attr("x", 20)
                .attr("y", 25)
                .attr("width", 60)
                .attr("height", 25)
                .style("fill", "#ccc");
            main_legend.append("text")
                .attr("x", 0)
                .attr("y", 20)
                .text("No Crime")
                .attr("font-size", "20");
            main_legend.append("text")
                .attr("x", 500)
                .attr("y", 20)
                .text("Most Crime")
                .attr("font-size", "20");
            
            for (var i = 0; i < color_range.length; i++) {
                main_legend.append("rect")
                    .attr("x", 63*i+83)
                    .attr("y", 25 )
                    .attr("width", 60)
                    .attr("height", 25)
                    .style("fill", color_range[i]);
                // main_legend.append("text")
                //     .attr("x", 75)
                //     .attr("y", 32 + 40 * (i + 1))
                //     .text(index_note[i])
                //     .attr("font-size", "20")
            }
        }

        // define cat view
        function draw_cat_view(data) {
            var allCrime = data.getAllCrimeDataByCat();
            // Set up Xscale
            var xScale = d3.scaleBand()
                .rangeRound([sec_margin.left, sec_width - sec_margin.right], .1)
                .domain(data.getCrime());
            // Set up Yscale
            var yScale = d3.scaleLinear()
                .rangeRound([sec_height - sec_margin.bottom, sec_margin.top]);
            var updateYScale = (yScale, zip = 512) => {
                yScale.domain([0, d3.max(Object.values(data.getCrimeDataByZip(zip))) *
                    1.25
                ]); // the default value is the while map
            };
            updateYScale(yScale);
            // Define xAxis
            var xAxis = d3.axisBottom(xScale).tickSizeOuter(0).tickPadding(5);
            // Define yAxis
            var yAxis = d3.axisLeft(yScale)
                .tickFormat(d3.format(".2s"));
            // Draw xAxis
            cat_graph.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + sec_margin.left + "," + (sec_margin.top + sec_height - 10) + ")")
                .call(xAxis);
            // Draw yAxis
            cat_graph.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + (sec_margin.left + 10) + "," + 0 + ")")
                .call(yAxis);
            // Define bars
            var bars = barChart()
                .setHeight(sec_height)
                .setScale(xScale, yScale)
                .setZip(512); // the default value is the while map
            //Draw bars
            cat_graph.datum(allCrime)
                .call(bars);

            return {
                svg: cat_graph,
                data: allCrime,
                update: updateYScale,
                xScale: xScale,
                yScale: yScale,
                xAxis: xAxis,
                yAxis: yAxis,
                mark: bars
            };
        }

        // define time view
        function draw_time_view(data) {
            var allCrime = data.getAllMonthDataByMonth();
            // Set up Xscale
            var xScale = d3.scaleBand()
                .rangeRound([sec_margin.left, sec_width - sec_margin.right], .1)
                .domain(Object.keys(data.getMonth()));
            // Set up Yscale
            var yScale = d3.scaleLinear()
                .rangeRound([sec_height - sec_margin.bottom, sec_margin.top]);
            var updateYScale = (yScale, zip = 512) => {
                yScale.domain([d3.min(Object.values(data.getMonthDataByZip(zip))), d3.max(Object.values(data
                    .getMonthDataByZip(zip))) * 1.10]) // the default value is the while map
            }
            updateYScale(yScale);
            // Define xAxis
            var xAxis = d3.axisBottom(xScale).tickSizeOuter(0).tickPadding(5);
            // Define yAxis
            var yAxis = d3.axisLeft(yScale)
                .tickFormat(d3.format("d"));
            // Draw xAxis
            time_graph.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + sec_margin.left + "," + (sec_margin.top + sec_height - 10) + ")")
                .call(xAxis);
            // Draw yAxis
            time_graph.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + (sec_margin.left + 20) + "," + 0 + ")")
                .call(yAxis);
            // Define line
            var line = lineChart()
                .setHeight(sec_height)
                .setScale(xScale, yScale)
                .setZip(512); // the default value is the while map
            //Draw line
            time_graph.datum(allCrime)
                .call(line);

            return {
                svg: time_graph,
                data: allCrime,
                update: updateYScale,
                xScale: xScale,
                yScale: yScale,
                xAxis: xAxis,
                yAxis: yAxis,
                mark: line
            };
        }

        // define main view
        function draw_main_view(json) {
            var w = (main_width + main_margin.left + main_margin.right) / 2;
            var h = (main_height + main_margin.top + main_margin.bottom) / 2;
            var mainProjection = d3.geoMercator()
                .center([-97.725073, 30.287884])
                .fitExtent([
                    [0, 0],
                    [w * 1.7, h * 1.7]
                ], json)
                .translate([w, h]);
            var mainPath = d3.geoPath().projection(mainProjection);
            // Zoom and Panning
            var zoom = d3.zoom()
                .extent([
                    [0, 0],
                    [w * 1.7, h * 1.7]
                ])
                .scaleExtent([1, 10])
                .translateExtent([
                    [main_margin.top, main_margin.left],
                    [main_height - main_margin.bottom, main_width - main_margin.right]
                ])
                .on("zoom", zoomed);

            function zoomed() {
                main.selectAll("path").attr("transform", () => d3.event.transform)
            }

            function resetted() {
                console.log("resetted");
                main.transition()
                    .duration(1000)
                    .call(zoom.transform, d3.zoomIdentity);
            }

            // Bind data and create one path per GeoJSON feature
            main.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", mainPath)
                .attr("stroke", "black")
                .attr("value", d => d.properties.geoid10)
                .attr("stoke-width", 1)
                .style("fill", d => d.properties.value ? color(d.properties.value) : "#ccc")
                .style("fill-opacity", 1)
                .on("mouseover", selected)
                .on("mouseout", restored)
                .append("title")
                .text(d => d.properties.geoid10);

            main.call(zoom);
            return resetted;
        }

        // function for updating view
        function updateView(view, zip) {
            view.update(view.yScale, zip);
            view.yAxis.scale(view.yScale);
            view.svg.select(".y.axis").transition(1000).call(view.yAxis);
            view.mark.setZip(zip);
            view.mark.setScale(view.xScale, view.yScale);
            view.mark.update(view.svg);
        };

        // combined draw function
        function draw(data, json) {
            // This is for debugging
            window.data = data;
            window.json = json
            window.d3 = d3;
            var saftyIdx = data.getAllSafetyIdx();

            // bind each zip section with the safty index
            data.getZip().forEach(zip => {
                json.features.forEach((d, i) => {
                    if (d.properties.geoid10 == zip)  json.features[i].properties.value = saftyIdx[zip];
                })
            });

            function changeZip(d) {
                console.log(d.properties.geoid10);
                document.getElementById("currentSelection").innerHTML = d.properties.geoid10 + " ";
                updateView(left_view, d.properties.geoid10);
                updateView(right_view, d.properties.geoid10);
            };

            var left_view = draw_cat_view(data);
            var right_view = draw_time_view(data);
            var resetted = draw_main_view(json);
            var legend_view = draw_legend();
            main.selectAll("path").on("click", changeZip);

            function restore() {
                resetted();
                document.getElementById("currentSelection").innerHTML = "Austin";
                updateView(left_view, 512);
                updateView(right_view, 512);
            };

            // restore Autin View
            document.getElementById("restore").onclick = restore;

        }

        // draw the main map in the center
        d3.csv("processed_data.csv", function (d) {
            var data = Data();
            data.setRawData(d);
            var saftyIdx = Object.values(data.getAllSafetyIdx());
            color.domain([Math.min.apply(null, saftyIdx), Math.max.apply(null, saftyIdx)]);
            d3.json("Boundaries_Zip.geojson", function (json) {
                draw(data, json);
            });
        });
    </script>
</body>

</html>