<!DOCTYPE html>
<html>

<head>
    <script type="text/javascript" src="https://d3js.org/d3.v4.js"></script>
    <script type="text/javascript" src="data_process.js"></script>
    <script type="text/javascript" src="barchart_closure.js"></script>
    <script type="text/javascript" src="linechart_closure.js"></script>
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
    <script src="https://d3js.org/d3-geo-projection.v2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.13.0/d3-legend.js"></script>
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="maincontainer">
        <h1>Austin Criminal Analytical Map</h1>
        <div id="category_graph">
            <h2> Crime Catagory Graph </h2>
        </div>
        <div id="main_graph">
            <span id="SelectionNode">
                <a> Current Selection: </a><a id="currentSelection">Austin</a>
                <button id="restore" type="button">Restore</button>
            </span>
        </div>
        <div id="time_series_graph">
            <h2> Time Series Graph </h2>
        </div>
    </div>

    <script>
        // Main view dimension {MARKER}
        var main_height = 800;
        var main_width = 800;
        var main_margin = {
            "top": 20,
            "bottom": 20,
            "left": 20,
            "right": 20
        };

        // Sub view dimension
        var sec_height = 400;
        var sec_width = 400;

        var sec_margin = {
            "top": 12,
            "bottom": 12,
            "left": 20,
            "right": 12
        };

        var left_graph = d3.select("#category_graph").append("svg")
            .attr("width", sec_width + sec_margin.left + sec_margin.right)
            .attr("height", sec_height + sec_margin.top + sec_margin.bottom);

        var main_legend = d3.select("#main_graph").append("svg")
            .attr("transform", "translate(-320,-600)")
            .attr("width", 250)
            .attr("height", 200);

        var main = d3.select("#main_graph").append("svg")
            .attr("transform", "translate(-160,0)")
            .attr("width", main_width + main_margin.left + main_margin.right)
            .attr("height", main_height + main_margin.top + main_margin.bottom);

        var right_graph = d3.select("#time_series_graph").append("svg")
            .attr("width", sec_width + sec_margin.left + sec_margin.right)
            .attr("height", sec_height + sec_margin.top + sec_margin.bottom);
        var color_range = ["#315B29", "#B0D2AD", "#E49C9D", "#AA2E24"];
        var index_note = ["Little Crimes", "Some Crimes", "Many Crimes", "Lots of Crimes"];
        var color = d3.scaleQuantize().range(color_range);

        function draw_legend() {
            // #draw the color legend
            main_legend.append("rect")
                .attr("x", 0)
                .attr("y", 10 + 40 * 0)
                .attr("width", 70)
                .attr("height", 30)
                .style("fill", "#cccccc");
            main_legend.append("text")
                .attr("x", 75)
                .attr("y", 32 + 40 * 0)
                .text("No Crime Reported")
                .attr("font-size", "20")
            for (var i = 0; i < color_range.length; i++) {
                main_legend.append("rect")
                    .attr("x", 0)
                    .attr("y", 10 + 40 * (i + 1))
                    .attr("width", 70)
                    .attr("height", 30)
                    .style("fill", color_range[i]);
                main_legend.append("text")
                    .attr("x", 75)
                    .attr("y", 32 + 40 * (i + 1))
                    .text(index_note[i])
                    .attr("font-size", "20")
            }
        }
        // draw the main map in the center
        var projection = d3.geoAlbersUsa()
            .translate([main_width / 2, main_height / 2])
            .scale([500]);

        // define left view
        function draw_left_view(data) {
            var allCrime = data.getAllCrimeDataByCat();
            // Set up Xscale
            var xScale = d3.scaleBand()
                .rangeRound([sec_margin.left, sec_width - sec_margin.right], .1)
                .domain(data.getCrime());
            // Set up Yscale
            var yScale = d3.scaleLinear()
                .rangeRound([sec_height - sec_margin.bottom, sec_margin.top]);
            var updateYScale = (yScale, zip = 512) => {
                yScale.domain([0, d3.max(Object.values(data.getCrimeDataByZip(zip))) *
                    1.25
                ]); // the default value is the while map
            };
            updateYScale(yScale);
            // Define xAxis
            var xAxis = d3.axisBottom(xScale).tickSizeOuter(0).tickPadding(5);
            // Define yAxis
            var yAxis = d3.axisLeft(yScale)
                .tickFormat(d3.format(".2s"));
            // Draw xAxis
            left_graph.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + sec_margin.left + "," + (sec_margin.top + sec_height - 10) + ")")
                .call(xAxis);
            // Draw yAxis
            left_graph.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + (sec_margin.left + 10) + "," + 0 + ")")
                .call(yAxis);
            // Define bars
            var bars = barChart()
                .setHeight(sec_height)
                .setScale(xScale, yScale)
                .setZip(512); // the default value is the while map
            //Draw bars
            left_graph.datum(allCrime)
                .call(bars);

            return {
                svg: left_graph,
                data: allCrime,
                update: updateYScale,
                xScale: xScale,
                yScale: yScale,
                xAxis: xAxis,
                yAxis: yAxis,
                mark: bars
            };
        }

        // define right view
        function draw_right_view(data) {
            var allCrime = data.getAllMonthDataByMonth();
            // Set up Xscale
            var xScale = d3.scaleBand()
                .rangeRound([sec_margin.left, sec_width - sec_margin.right], .1)
                .domain(Object.keys(data.getMonth()));
            // Set up Yscale
            var yScale = d3.scaleLinear()
                .rangeRound([sec_height - sec_margin.bottom, sec_margin.top]);
            var updateYScale = (yScale, zip = 512) => {
                yScale.domain([d3.min(Object.values(data.getMonthDataByZip(zip))), d3.max(Object.values(data
                    .getMonthDataByZip(zip))) * 1.10]) // the default value is the while map
            }
            updateYScale(yScale);
            // Define xAxis
            var xAxis = d3.axisBottom(xScale).tickSizeOuter(0).tickPadding(5);
            // Define yAxis
            var yAxis = d3.axisLeft(yScale)
                .tickFormat(d3.format("d"));
            // Draw xAxis
            right_graph.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(" + sec_margin.left + "," + (sec_margin.top + sec_height - 10) + ")")
                .call(xAxis);
            // Draw yAxis
            right_graph.append("g")
                .attr("class", "y axis")
                .attr("transform", "translate(" + (sec_margin.left + 20) + "," + 0 + ")")
                .call(yAxis);
            // Define line
            var line = lineChart()
                .setHeight(sec_height)
                .setScale(xScale, yScale)
                .setZip(512); // the default value is the while map
            //Draw line
            right_graph.datum(allCrime)
                .call(line);

            return {
                svg: right_graph,
                data: allCrime,
                update: updateYScale,
                xScale: xScale,
                yScale: yScale,
                xAxis: xAxis,
                yAxis: yAxis,
                mark: line
            };
        }

        function updateView(view, zip) {
            view.update(view.yScale, zip);
            view.yAxis.scale(view.yScale);
            view.svg.select(".y.axis").transition(1000).call(view.yAxis);
            view.mark.setZip(zip);
            view.mark.setScale(view.xScale, view.yScale);
            view.mark.update(view.svg);
        };


        // draw function
        function draw(data, json) {
            // This is for debugging
            window.data = data;
            window.d3 = d3;


            var key_collection = data.getZip();
            var dataset = data.getAllSafetyIdx();
            // bind each zip section with the safty index
            for (var i = 0; i < key_collection.length; i++) {
                var zip_name = key_collection[i];
                var zip_index = parseFloat(dataset[zip_name]);
                for (var j = 0; j < json.features.length; j++) {
                    var json_zip = json.features[j].properties.geoid10;
                    if (zip_name == json_zip) {
                        json.features[j].properties.value = zip_index;
                        // console.log(zip_index);
                        break
                    }
                }
            }

            var w = (main_width + main_margin.left + main_margin.right) / 2;
            var h = (main_height + main_margin.top + main_margin.bottom) / 2;
            var mainProjection = d3.geoMercator()
                .center([-97.725073, 30.287884])
                .fitExtent([
                    [0, 0],
                    [w * 1.7, h * 1.7]
                ], json)
                .translate([w, h]);
            var mainPath = d3.geoPath().projection(mainProjection);
            var selected = function (d, i) {
                d3.select(this).style('fill-opacity', 1);
            };
            var restored = function (d, i) {
                d3.select(this)
                    .style('fill-opacity', 0.7);
            };

            // Bind data and create one path per GeoJSON feature
            main.selectAll("path")
                .data(json.features)
                .enter()
                .append("path")
                .attr("d", mainPath)
                .attr("stroke", "black")
                .attr("value", function (d) {
                    return d.properties.geoid10;
                })
                .attr("stoke-width", "1")
                .style("fill", function (d) {
                    // get the binded index value
                    var value = d.properties.value;
                    if (value) {
                        return color(value);
                    } else {
                        return "#ccc";
                    }
                })
                .style("fill-opacity", 0.7)
                .on("mouseover", selected)
                .on("mouseout", restored)
                .on("click", changeZip)
                .append("title")
                .text(d => d.properties.geoid10);

            // Zoom and Panning
            var zoom = d3.zoom()
                .extent([
                    [0, 0],
                    [w * 1.7, h * 1.7]
                ])
                .scaleExtent([1, 10])
                .translateExtent([
                    [main_margin.top, main_margin.left],
                    [main_height - main_margin.bottom, main_width - main_margin.right]
                ])
                .on("zoom", zoomed);

            function zoomed() {
                main.selectAll("path").attr("transform", () => d3.event.transform)
            }

            function resetted() {
                console.log("resetted");
                main.transition()
                    .duration(1000)
                    .call(zoom.transform, d3.zoomIdentity);
            }

            main.call(zoom);

            function changeZip(d) {
                console.log(d.properties.geoid10);
                document.getElementById("currentSelection").innerHTML = d.properties.geoid10 + " ";
                updateView(left_view, d.properties.geoid10);
                updateView(right_view, d.properties.geoid10);
            };

            var left_view = draw_left_view(data);
            var right_view = draw_right_view(data);

            // #restore Autin View
            document.getElementById("restore").onclick = restore;

            function restore() {
                resetted();
                document.getElementById("currentSelection").innerHTML = "Austin";
                updateView(left_view, 512);
                updateView(right_view, 512);
            };
        }

        // draw the main map in the center
        d3.csv("processed_data.csv", function (d) {
            var data = Data();
            data.setRawData(d);
            var dataset = data.getAllSafetyIdx();
            // console.log(dataset);
            var value_collection = [];
            var key_collection = data.getZip();
            for (var l = 0; l < key_collection.length; l++) {
                value_collection.push(parseFloat(dataset[key_collection[l]]));
            }

            color.domain([Math.min.apply(null, value_collection), Math.max.apply(null, value_collection)]);

            d3.json("Boundaries_Zip.geojson", function (json) {
                draw(data, json);
                draw_legend();
            });
        });
    </script>
</body>

</html>